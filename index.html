<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Booking Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Animation Library -->
    <script src="https://cdn.jsdelivr.net/npm/motion@latest/dist/motion.js"></script>
    <!-- Date Picker Library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #555; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #777; }
        .calendar-day { transition: all 0.2s ease-in-out; }
        /* Style disabled inputs for a better read-only look */
        input:disabled, textarea:disabled, input[type=checkbox]:disabled {
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
        .dark input:disabled, .dark textarea:disabled {
            background-color: #374151;
        }
        /* Custom scrollbar for upcoming bookings */
        #upcoming-bookings-container::-webkit-scrollbar { height: 6px; }
        #upcoming-bookings-container::-webkit-scrollbar-track { background: #e0e0e0; border-radius: 3px;}
        .dark #upcoming-bookings-container::-webkit-scrollbar-track { background: #4a5568; }
        #upcoming-bookings-container::-webkit-scrollbar-thumb { background: #a0a0a0; border-radius: 3px; }
        .dark #upcoming-bookings-container::-webkit-scrollbar-thumb { background: #718096; }
        /* Custom styles for flatpickr */
        .flatpickr-calendar.dark {
            background: #1A2F2E;
            border-color: #2A4A48;
        }
        .flatpickr-calendar.dark .flatpickr-day:hover,
        .flatpickr-calendar.dark .flatpickr-day:focus {
            background: #2A4A48;
        }
        .flatpickr-calendar.dark .flatpickr-day.selected {
            background: #6fe7dd;
            border-color: #6fe7dd;
            color: #102221;
        }
        .flatpickr-calendar.dark .flatpickr-day.today {
            border-color: #3490de;
        }
        .flatpickr-calendar.dark .flatpickr-weekday,
        .flatpickr-calendar.dark .flatpickr-monthDropdown-months,
        .flatpickr-calendar.dark .numInput,
        .flatpickr-calendar.dark .cur-month {
            color: #f7fdfd;
        }
        .dark .flatpickr-time input, .dark .flatpickr-time .flatpickr-am-pm {
             background: #102221;
             color: #f7fdfd;
        }
    </style>
    <script>
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'text': '#102221',
                        'background': '#f7fdfd',
                        'primary': '#6fe7dd',
                        'secondary': '#3490de',
                        'accent': '#6639a6',
                        'dark-text': '#f7fdfd',
                        'dark-background': '#102221',
                        'dark-card': '#1A2F2E',
                        'dark-border': '#2A4A48',
                        'light-border': '#e5e7eb', // Similar to gray-200
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-background dark:bg-dark-background text-text dark:text-dark-text transition-colors duration-300">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex flex-wrap justify-between items-center mb-6 gap-4">
            <h1 class="text-3xl font-bold text-primary flex items-center gap-3 cursor-pointer">
                <i id="header-icon" class="fa-solid fa-seedling"></i>
                <span data-lang-key="title">Farm Booking Manager</span>
            </h1>
            <div class="flex items-center space-x-2 md:space-x-4">
                <button id="language-toggle-btn" class="text-sm font-semibold bg-white dark:bg-dark-card border border-light-border dark:border-dark-border rounded-lg py-2 px-4 hover:bg-gray-50 dark:hover:bg-dark-background focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-offset-dark-background transition-colors w-28">
                    <!-- Text set by JS -->
                </button>
                <button id="theme-switcher" class="w-10 h-10 flex justify-center items-center rounded-full bg-white dark:bg-dark-card border border-light-border dark:border-dark-border hover:bg-gray-50 dark:hover:bg-dark-background focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-offset-dark-background transition-colors">
                    <i id="theme-icon" class="fa-solid fa-sun text-lg text-yellow-500"></i>
                </button>
            </div>
        </header>

        <!-- Upcoming Bookings Banner -->
        <section id="upcoming-bookings-section" class="mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-3" data-lang-key="upcoming_bookings">
                <i class="fa-solid fa-calendar-days text-primary"></i>
                Upcoming Bookings
            </h2>
            <div id="upcoming-bookings-container" class="flex gap-4 overflow-x-auto pb-4">
                <!-- Upcoming booking cards will be injected here by JS -->
            </div>
        </section>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-3 flex flex-col gap-8">
                <!-- Calendar Card -->
                <div class="bg-white dark:bg-dark-card p-4 md:p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-dark-background flex items-center justify-center"><i id="prev-month-icon" class="fa-solid fa-chevron-left"></i></button>
                        <h2 id="month-year" class="text-xl font-semibold text-center"></h2>
                        <button id="next-month" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-dark-background flex items-center justify-center"><i id="next-month-icon" class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div id="calendar-header" class="grid grid-cols-7 gap-2 text-center text-sm font-medium text-gray-500 dark:text-gray-400 mb-2"></div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 md:gap-2"></div>
                     <div class="text-center mt-4">
                        <button id="goto-today" class="px-4 py-2 text-sm bg-primary/20 text-text dark:text-dark-text rounded-lg hover:bg-primary/30" data-lang-key="goto_today">Go to Today</button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Booking Details -->
            <div class="lg:col-span-2 bg-white dark:bg-dark-card p-4 md:p-6 rounded-2xl shadow-lg h-fit">
                <h3 class="text-xl font-bold mb-2" data-lang-key="booking_details">Booking Details</h3>
                <p id="selected-date-display" class="font-semibold text-primary mb-4 h-6" data-lang-key="select_date_prompt">Select a date to see details.</p>
                <div id="booking-info" class="space-y-3">
                    <!-- Booking slot cards will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit/View Booking Modal -->
    <div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-50 p-4 sm:p-6 md:p-8 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark-card rounded-2xl shadow-2xl w-full h-full transform transition-all scale-95 opacity-0 flex flex-col relative" id="modal-content">
            
            <button id="modal-close-btn-top" class="absolute top-4 right-4 z-10 w-9 h-9 flex items-center justify-center rounded-full text-text dark:text-dark-text bg-gray-200/80 dark:bg-dark-border/80 hover:bg-gray-300 dark:hover:bg-dark-border transition-colors">
                <i class="fa-solid fa-times"></i>
            </button>

            <!-- MODAL HEADER -->
            <div class="flex-shrink-0 p-6 text-center border-b border-light-border dark:border-dark-border">
                <h2 id="modal-title" class="text-2xl font-bold mb-2"></h2>
                <p id="modal-date-display" class="font-semibold text-lg text-gray-500 dark:text-gray-400 mb-2"></p>
            </div>

            <!-- SCROLLABLE FORM BODY -->
            <div class="flex-grow overflow-y-auto p-6">
                <form id="booking-form" class="grid grid-cols-1 lg:grid-cols-5 gap-x-8 gap-y-6">
                    <input type="hidden" id="booking-date">
                    <input type="hidden" id="editing-slot">
                    
                    <!-- LEFT COLUMN -->
                    <div class="flex flex-col gap-6 lg:col-span-3">
                        <div class="space-y-4">
                             <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="customer-name" class="block text-sm font-medium mb-1" data-lang-key="customer_name">Customer Name</label>
                                    <input type="text" id="customer-name" required class="w-full px-3 py-1.5 border border-light-border dark:border-dark-border rounded-lg bg-background dark:bg-dark-background focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label for="contact-info" class="block text-sm font-medium mb-1" data-lang-key="contact_info">Contact Info</label>
                                    <input type="text" id="contact-info" required class="w-full px-3 py-1.5 border border-light-border dark:border-dark-border rounded-lg bg-background dark:bg-dark-background focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                            </div>
                            <div>
                                <label for="booking-details-text" class="block text-sm font-medium mb-1" data-lang-key="details_notes">Details / Notes</label>
                                <textarea id="booking-details-text" rows="1" class="w-full px-3 py-1.5 border border-light-border dark:border-dark-border rounded-lg bg-background dark:bg-dark-background focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                            </div>
                        </div>

                        <div id="item-details-section" class="border-t border-b border-light-border dark:border-dark-border py-4">
                            <div class="hidden md:grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 dark:text-gray-400 px-2 mb-2">
                                <div class="col-span-5" data-lang-key="item_detail">વિગત</div>
                                <div class="col-span-2 text-center" data-lang-key="item_price">ભાવ</div>
                                <div class="col-span-2 text-center" data-lang-key="item_qty">નંગ</div>
                                <div class="col-span-3 text-right" data-lang-key="item_total">ટોટલ</div>
                            </div>
                            <div id="item-checklist" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                <!-- Item rows will be generated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN -->
                    <div class="flex flex-col gap-6 lg:col-span-2">
                         <div id="booking-slot-container">
                            <span class="block text-sm font-medium mb-2" data-lang-key="booking_slot">Booking Slot</span>
                            <div class="grid grid-cols-3 gap-2" id="booking-slots"></div>
                        </div>

                         <div class="space-y-4">
                            <div class="flex justify-between items-baseline text-2xl font-bold">
                                <span data-lang-key="grand_total">Grand Total:</span>
                                <span id="grand-total" class="ml-4">₹0</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1" data-lang-key="advanced_payment">Advanced Payment</label>
                                <div class="grid grid-cols-2 gap-2">
                                     <input type="number" id="advanced-payment-amount" placeholder="₹" class="w-full px-3 py-2 border border-light-border dark:border-dark-border rounded-lg bg-background dark:bg-dark-background focus:outline-none focus:ring-2 focus:ring-primary">
                                     <input type="text" id="advanced-payment-date" class="date-picker w-full px-3 py-2 border border-light-border dark:border-dark-border rounded-lg bg-background dark:bg-dark-background focus:outline-none focus:ring-2 focus:ring-primary" data-lang-placeholder="select_date">
                                </div>
                            </div>
                             <div class="flex justify-between text-md font-semibold border-t border-light-border dark:border-dark-border pt-2 mt-2">
                                <span data-lang-key="total_paid">Total Paid:</span>
                                <span id="total-paid" class="ml-4 text-green-500">₹0</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold">
                                <span data-lang-key="remaining_amount">Remaining:</span>
                                <span id="remaining-amount" class="ml-4 text-red-500">₹0</span>
                            </div>
                         </div>
                         
                         <div class="border-t border-light-border dark:border-dark-border pt-4">
                             <div class="flex justify-between items-center mb-2">
                                 <label class="text-sm font-medium" data-lang-key="installments">Installments</label>
                                 <div class="flex items-center gap-1">
                                    <span class="text-xs mr-1 hidden sm:inline" data-lang-key="auto_divide">Divide in:</span>
                                    <button type="button" data-count="2" class="installment-divider-btn w-6 h-6 text-xs flex items-center justify-center rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-dark-border dark:hover:bg-dark-background font-bold">2</button>
                                    <button type="button" data-count="3" class="installment-divider-btn w-6 h-6 text-xs flex items-center justify-center rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-dark-border dark:hover:bg-dark-background font-bold">3</button>
                                    <button type="button" data-count="4" class="installment-divider-btn w-6 h-6 text-xs flex items-center justify-center rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-dark-border dark:hover:bg-dark-background font-bold">4</button>
                                    <button type="button" id="add-installment-btn" class="w-8 h-8 flex items-center justify-center rounded-full bg-primary/20 hover:bg-primary/40 text-primary">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                 </div>
                             </div>
                             <div id="installments-container" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                                 <!-- Installment rows will be added here -->
                             </div>
                         </div>
                    </div>
                </form>
            </div>

            <!-- MODAL FOOTER -->
            <div class="flex-shrink-0 p-6 mt-auto border-t border-light-border dark:border-dark-border">
                <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                    <button type="submit" form="booking-form" id="modal-save-btn" class="w-full sm:w-auto px-5 py-2 rounded-lg bg-primary text-text hover:bg-opacity-80 font-semibold flex items-center justify-center gap-2"><i class="fa-solid fa-check"></i> <span data-lang-key="save_booking">Save Booking</span></button>
                    <button type="button" id="modal-edit-btn" class="w-full sm:w-auto px-5 py-2 rounded-lg bg-secondary text-dark-text hover:bg-opacity-80 font-semibold flex items-center justify-center gap-2"><i class="fa-solid fa-pencil"></i> <span data-lang-key="edit">Edit</span></button>
                    <button type="button" id="cancel-modal-btn" class="w-full sm:w-auto px-5 py-2 rounded-lg bg-gray-200 dark:bg-dark-border hover:bg-gray-300 dark:hover:bg-opacity-80 font-semibold flex items-center justify-center gap-2"><i class="fa-solid fa-times"></i> <span data-lang-key="cancel">Cancel</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-50 p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark-card rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center transform transition-all scale-95 opacity-0" id="delete-modal-content">
            <i class="fa-solid fa-triangle-exclamation text-4xl text-red-500 mb-4"></i>
            <h2 class="text-xl font-bold mb-2" data-lang-key="confirm_delete_title">Confirm Deletion</h2>
            <p class="mb-6 text-gray-600 dark:text-gray-400" data-lang-key="confirm_delete_text">Are you sure? This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="px-5 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold" data-lang-key="cancel">Cancel</button>
                <button id="confirm-delete-btn" class="px-5 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-semibold flex items-center gap-2"><i class="fa-solid fa-trash-can"></i> <span data-lang-key="delete">Delete</span></button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    let currentDate = new Date();
    let selectedDate = null;
    let currentLang = 'en';
    let bookingToDelete = null;
    let bookings = {};

    // --- MASTER ITEM LIST ---
    const masterItems = [
        { id: 'passage_carpet', price: 10, gu: 'એન્ટ્રી થી માયરા સુધી પેસેજ કાર્પેટ', en: 'Passage Carpet (per sq ft)' },
        { id: 'stage', price: 15, gu: 'સ્ટેજ (પર સ્ક્વેર ફીટ)', en: 'Stage (per sq ft)' },
        { id: 'mayra_chair', price: 0, gu: 'માયરા ની ખુરશી / સોફો / હિંડોળો', en: 'Mayra Chair / Sofa / Swing' },
        { id: 'mattress', price: 20, gu: 'ગાદલા', en: 'Mattress' },
        { id: 'vvip_sofa', price: 500, gu: 'વી.વી.આઈ.પી સોફા', en: 'VVIP Sofa' },
        { id: 'banquet_chair', price: 30, gu: 'બેન્કવેટ ખુરશી', en: 'Banquet Chair' },
        { id: 'counter_table', price: 150, gu: 'કાઉન્ટર ટેબલ', en: 'Counter Table' },
        { id: 'round_table', price: 200, gu: 'રાઉન્ડ ટેબલ', en: 'Round Table' },
        { id: 'light_bill', price: 30, gu: 'લાઈટબીલ પર યુનિટ', en: 'Light Bill (per unit)' },
        { id: 'lbt_light', price: 300, gu: 'માયરા માટે પાર LBT લાઈટ', en: 'LBT Light for Mayra' },
        { id: 'havan_kund', price: 0, gu: 'હવન કુંડ', en: 'Havan Kund' },
        { id: 'smc_dustbin', price: 0, gu: 'S.M.C. કચરા પેટી', en: 'SMC Dustbin' },
        { id: 'cleaning_charge', price: 0, gu: 'સફાઈ ચાર્જ', en: 'Cleaning Charge' },
        { id: 'watchman', price: 700, gu: 'વોચમેન', en: 'Watchman' },
        { id: 'washbasin', price: 500, gu: 'વોશબેજીન', en: 'Washbasin' },
        { id: 'ac_full', price: 7000, gu: 'એ.સી. (પર કલાક)', en: 'AC (per hour)' },
        { id: 'ac_half', price: 3000, gu: 'એ.સી. હાલ્ફ યુનિટ (પર કલાક)', en: 'AC Half Unit (per hour)' },
    ];

    // --- LOCAL STORAGE FUNCTIONS ---
    const loadState = () => {
        const savedBookings = localStorage.getItem('farmBookings');
        bookings = savedBookings ? JSON.parse(savedBookings) : {
            [new Date(Date.now() + 86400000).toISOString().split('T')[0]]: [{ 
                slot: 'morning', name: 'Alice Johnson', contact: '555-0101', details: 'Birthday Party Setup',
                items: [ { id: 'passage_carpet', price: 10, quantity: 100 }, { id: 'banquet_chair', price: 30, quantity: 50 } ],
                grandTotal: 2500,
                advancedPayment: { amount: 500, date: new Date().toISOString().split('T')[0] },
                installments: [{ amount: 1000, date: '2025-10-01' }]
            }],
        };
        // Data migration for older advancedPayment format
         Object.values(bookings).forEach(dayBookings => {
            dayBookings.forEach(booking => {
                if (typeof booking.advancedPayment === 'number') {
                    booking.advancedPayment = { amount: booking.advancedPayment, date: null };
                }
            });
        });
        const savedLang = localStorage.getItem('farmLang');
        currentLang = savedLang || 'en';
        const savedTheme = localStorage.getItem('farmTheme');
        if (savedTheme === 'dark') document.documentElement.classList.add('dark');
    };
    const saveState = () => {
        localStorage.setItem('farmBookings', JSON.stringify(bookings));
        localStorage.setItem('farmLang', currentLang);
        localStorage.setItem('farmTheme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    };

    // --- TRANSLATIONS ---
    const translations = {
        en: { title: "Farm Booking Manager", upcoming_bookings: "Upcoming Bookings", no_upcoming_bookings: "No upcoming bookings found.", booking_details: "Booking Details", grand_total: "Grand Total:", select_date_prompt: "Select a date to see details.", add_booking: "Add Booking", add_new_booking: "Add New Booking", edit_booking: "Edit Booking", customer_name: "Customer Name", contact_info: "Contact Info", details_notes: "Details / Notes", booking_slot: "Booking Slot", morning: "Morning", afternoon: "Afternoon", night: "Night", cancel: "Cancel", save_booking: "Save Booking", booked_by: "Booked by", contact: "Contact", amount: "Amount", no_bookings: "This slot is available.", months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"], days: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"], edit: "Edit", delete: "Delete", confirm_delete_title: "Confirm Deletion", confirm_delete_text: "Are you sure? This action cannot be undone.", vacant: "Vacant", goto_today: "Go to Today", view_details: "View Details", view_booking: "View Booking", close: "Close", item_detail: "Detail", item_price: "Price", item_qty: "Qty", item_total: "Total", advanced_payment: "Advanced Payment", installments: "Installments", select_date: "Select Date", installment_amount: "Amount", installment_date: "Date", total_paid: "Total Paid:", remaining_amount: "Remaining:", auto_divide: "Divide in:" },
        gu: { title: "ફાર્મ બુકિંગ મેનેજર", upcoming_bookings: "આગામી બુકિંગ", no_upcoming_bookings: "કોઈ આગામી બુકિંગ મળ્યું નથી.", booking_details: "બુકિંગ વિગતો", grand_total: "કુલ ટોટલ:", select_date_prompt: "વિગતો જોવા માટે તારીખ પસંદ કરો.", add_booking: "બુકિંગ ઉમેરો", add_new_booking: "નવું બુકિંગ ઉમેરો", edit_booking: "બુકિંગ સંપાદિત કરો", customer_name: "ગ્રાહકનું નામ", contact_info: "સંપર્ક માહિતી", details_notes: "વિગતો / નોંધો", booking_slot: "બુકિંગ સ્લોટ", morning: "સવાર", afternoon: "બપોર", night: "રાત્રી", cancel: "રદ કરો", save_booking: "બુકિંગ સાચવો", booked_by: "દ્વારા બુક કરેલ", contact: "સંપર્ક", amount: "રકમ", no_bookings: "આ સ્લોટ ઉપલબ્ધ છે.", months: ["જાન્યુઆરી", "ફેબ્રુઆરી", "માર્ચ", "એપ્રિલ", "મે", "જૂન", "જુલાઈ", "ઓગસ્ટ", "સપ્ટેમ્બર", "ઓક્ટોબર", "નવેમ્બર", "ડિસેમ્બર"], days: ["રવિ", "સોમ", "મંગળ", "બુધ", "ગુરુ", "શુક્ર", "શનિ"], edit: "સંપાદિત કરો", delete: "કાઢી નાખો", confirm_delete_title: "કાઢી નાખવાની પુષ્ટિ કરો", confirm_delete_text: "શું તમે ચોક્કસ છો? આ ક્રિયાને પૂર્વવત્ કરી શકાતી નથી.", vacant: "ખાલી", goto_today: "આજે જાઓ", view_details: "વિગતો જુઓ", view_booking: "બુકિંગ જુઓ", close: "બંધ કરો", item_detail: "વિગત", item_price: "ભાવ", item_qty: "નંગ", item_total: "ટોટલ", advanced_payment: "એડવાન્સ પેમેન્ટ", installments: "હપતા", select_date: "તારીખ પસંદ કરો", installment_amount: "રકમ", installment_date: "તારીખ", total_paid: "કુલ ચૂકવેલ:", remaining_amount: "બાકી:", auto_divide: "માં વિભાજીત કરો:"},
    };
    const bookingSlots = [ { id: 'morning', icon: 'fa-sun', color: 'text-yellow-500' }, { id: 'afternoon', icon: 'fa-cloud-sun', color: 'text-orange-500' }, { id: 'night', icon: 'fa-moon', color: 'text-accent' }];

    // --- DOM ELEMENTS ---
    const allDOMElements = {
        monthYearEl: document.getElementById('month-year'), calendarGridEl: document.getElementById('calendar-grid'), calendarHeaderEl: document.getElementById('calendar-header'), prevMonthBtn: document.getElementById('prev-month'), nextMonthBtn: document.getElementById('next-month'), bookingInfoEl: document.getElementById('booking-info'), selectedDateDisplayEl: document.getElementById('selected-date-display'), modal: document.getElementById('booking-modal'), modalContent: document.getElementById('modal-content'), modalTitle: document.getElementById('modal-title'), cancelModalBtn: document.getElementById('cancel-modal-btn'), bookingForm: document.getElementById('booking-form'), modalDateDisplay: document.getElementById('modal-date-display'), languageToggleBtn: document.getElementById('language-toggle-btn'), themeSwitcher: document.getElementById('theme-switcher'), themeIcon: document.getElementById('theme-icon'), deleteModal: document.getElementById('delete-modal'), deleteModalContent: document.getElementById('delete-modal-content'), cancelDeleteBtn: document.getElementById('cancel-delete-btn'), confirmDeleteBtn: document.getElementById('confirm-delete-btn'), gotoTodayBtn: document.getElementById('goto-today'), modalEditBtn: document.getElementById('modal-edit-btn'), modalSaveBtn: document.getElementById('modal-save-btn'), upcomingBookingsContainer: document.getElementById('upcoming-bookings-container'), itemChecklist: document.getElementById('item-checklist'), grandTotalEl: document.getElementById('grand-total'), addInstallmentBtn: document.getElementById('add-installment-btn'), installmentsContainer: document.getElementById('installments-container'), totalPaidEl: document.getElementById('total-paid'), remainingAmountEl: document.getElementById('remaining-amount'), modalCloseBtnTop: document.getElementById('modal-close-btn-top'),
    };
    
    // --- DOM ELEMENTS (continued)
    const { bookingInfoEl, selectedDateDisplayEl } = allDOMElements;

    // --- FUNCTIONS ---
    const updateLangButtonText = () => allDOMElements.languageToggleBtn.textContent = currentLang === 'en' ? 'ગુજરાતી' : 'ENGLISH';
    
    const updatePaymentSummary = () => {
        const grandTotal = parseFloat(allDOMElements.grandTotalEl.textContent.replace('₹', '')) || 0;
        const advancedPayment = parseFloat(document.getElementById('advanced-payment-amount').value) || 0;

        let installmentsTotal = 0;
        document.querySelectorAll('.installment-row .installment-amount').forEach(input => {
            installmentsTotal += parseFloat(input.value) || 0;
        });

        const totalPaid = advancedPayment + installmentsTotal;
        const remainingAmount = grandTotal - totalPaid;

        allDOMElements.totalPaidEl.textContent = `₹${totalPaid.toFixed(2)}`;
        allDOMElements.remainingAmountEl.textContent = `₹${remainingAmount.toFixed(2)}`;
        
        return { grandTotal, totalPaid, remainingAmount };
    };

    const calculateTotals = () => {
        let grandTotal = 0;
        const itemRows = allDOMElements.itemChecklist.querySelectorAll('.item-row');
        itemRows.forEach(row => {
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
            const total = price * quantity;
            row.querySelector('.item-total').textContent = `₹${total}`;
            if (quantity > 0) grandTotal += total;
        });
        allDOMElements.grandTotalEl.textContent = `₹${grandTotal}`;
        updatePaymentSummary();
    };

    const renderUpcomingBookingsBanner = () => {
        const { upcomingBookingsContainer } = allDOMElements;
        upcomingBookingsContainer.innerHTML = '';
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = today.toISOString().split('T')[0];
        const allUpcoming = [];
        Object.keys(bookings).forEach(dateStr => {
            if (dateStr >= todayStr) {
                bookings[dateStr].forEach(booking => allUpcoming.push({ ...booking, date: dateStr }));
            }
        });
        allUpcoming.sort((a, b) => new Date(a.date) - new Date(b.date));
        const upcomingToShow = allUpcoming.slice(0, 10);
        if (upcomingToShow.length === 0) {
            upcomingBookingsContainer.innerHTML = `<div class="text-center w-full text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg" data-lang-key="no_upcoming_bookings">${translations[currentLang].no_upcoming_bookings}</div>`;
            return;
        }
        upcomingToShow.forEach(booking => {
            const slotInfo = bookingSlots.find(s => s.id === booking.slot);
            const dateObj = new Date(booking.date + 'T00:00:00');
            const day = dateObj.toLocaleDateString(currentLang === 'gu' ? 'gu-IN' : 'en-US', { day: '2-digit' });
            const month = dateObj.toLocaleDateString(currentLang === 'gu' ? 'gu-IN' : 'en-US', { month: 'short' });
            const cardHTML = `
                <div class="flex-shrink-0 w-64 bg-white dark:bg-dark-card p-4 rounded-2xl shadow-lg border border-transparent hover:border-primary hover:ring-1 hover:ring-primary transition-all cursor-pointer" onclick="document.querySelector('[data-date=\\'${booking.date}\\']').click()">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2 font-bold text-lg ${slotInfo.color}">
                            <i class="fa-solid ${slotInfo.icon}"></i>
                            <span>${translations[currentLang][booking.slot]}</span>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-2xl text-text dark:text-dark-text">${day}</p>
                            <p class="text-xs font-bold text-accent -mt-1">${month.toUpperCase()}</p>
                        </div>
                    </div>
                    <div class="border-t border-light-border dark:border-dark-border pt-2 mt-2">
                        <p class="text-md font-bold truncate" title="${booking.name}">${booking.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate" title="${booking.contact}">${booking.contact}</p>
                    </div>
                </div>`;
            upcomingBookingsContainer.innerHTML += cardHTML;
        });
    };

    const updateLanguage = () => {
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            if (translations[currentLang][key]) el.textContent = translations[currentLang][key];
        });
         document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
            const key = el.getAttribute('data-lang-placeholder');
            if (translations[currentLang][key]) el.placeholder = translations[currentLang][key];
        });
        allDOMElements.confirmDeleteBtn.querySelector('span').textContent = translations[currentLang].delete;
        renderCalendar();
        renderUpcomingBookingsBanner();
        if (selectedDate) displayBookingDetails(selectedDate);
        else {
            selectedDateDisplayEl.textContent = translations[currentLang].select_date_prompt;
            bookingInfoEl.innerHTML = '';
        }
    };

    const renderCalendar = () => {
        const { calendarGridEl, calendarHeaderEl, monthYearEl } = allDOMElements;
        calendarGridEl.innerHTML = ''; calendarHeaderEl.innerHTML = '';
        const month = currentDate.getMonth(), year = currentDate.getFullYear();
        monthYearEl.textContent = `${translations[currentLang].months[month]} ${year}`;
        translations[currentLang].days.forEach(day => calendarHeaderEl.innerHTML += `<div>${day}</div>`);
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDayOfMonth; i++) calendarGridEl.innerHTML += `<div></div>`;
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayEl.className = 'calendar-day h-16 md:h-20 p-1 md:p-2 border border-light-border dark:border-dark-border rounded-lg cursor-pointer hover:bg-primary/10 dark:hover:bg-primary/20 flex flex-col justify-between';
            dayEl.dataset.date = dateStr;
            let dayNumberHTML = `<span class="self-start text-sm font-medium">${day}</span>`;
            const today = new Date();
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayNumberHTML = `<span class="self-start text-sm bg-primary text-text rounded-full h-6 w-6 flex items-center justify-center font-bold">${day}</span>`;
            }
            let dotsHTML = '<div class="flex justify-center items-end space-x-1 h-2">';
            const dayBookings = bookings[dateStr] || [];
            if (dayBookings.length > 0) {
                bookingSlots.forEach(slotInfo => {
                    if (dayBookings.some(b => b.slot === slotInfo.id)) {
                        dotsHTML += `<span class="w-2 h-2 rounded-full ${ slotInfo.id === 'morning' ? 'bg-yellow-400' : slotInfo.id === 'afternoon' ? 'bg-orange-400' : 'bg-accent' }"></span>`;
                    }
                });
            }
            dotsHTML += '</div>';
            dayEl.innerHTML = dayNumberHTML + dotsHTML;
            if (selectedDate === dateStr) dayEl.classList.add('bg-primary/20', 'dark:bg-primary/30', 'border-primary', 'ring-2', 'ring-primary');
            calendarGridEl.appendChild(dayEl);
        }
    };

    const displayBookingDetails = (dateStr) => {
        selectedDate = dateStr;
        const dateObj = new Date(dateStr + 'T00:00:00');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        selectedDateDisplayEl.textContent = dateObj.toLocaleDateString(currentLang === 'gu' ? 'gu-IN' : 'en-US', options);
        bookingInfoEl.innerHTML = '';
        const dayBookings = bookings[dateStr] || [];
        bookingSlots.forEach(slotInfo => {
            const booking = dayBookings.find(b => b.slot === slotInfo.id);
            const slotCard = document.createElement('div');
            slotCard.className = 'p-4 rounded-lg border dark:border-dark-border transition-all ' + (booking ? 'bg-gray-50 dark:bg-dark-background' : 'bg-primary/10 dark:bg-primary/20 border-primary/30 dark:border-primary/40');
            let html = `<div class="flex justify-between items-start mb-2"><h4 class="font-bold text-lg flex items-center gap-2 ${slotInfo.color}"><i class="fa-solid ${slotInfo.icon}"></i><span>${translations[currentLang][slotInfo.id]}</span></h4>`;
            if (booking) {
                html += `<div class="flex space-x-2">
                             <button class="delete-btn text-sm bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300 px-2 py-1 rounded-md hover:bg-red-200 dark:hover:bg-red-800/50" data-slot="${slotInfo.id}" title="${translations[currentLang].delete}"><i class="fa-solid fa-trash-can fa-xs"></i></button>
                             <button class="view-btn text-sm bg-secondary/20 text-secondary dark:text-secondary px-3 py-1 rounded-md hover:bg-secondary/30 font-semibold" data-slot="${slotInfo.id}" data-lang-key="view_details">${translations[currentLang].view_details}</button>
                           </div>`;
            }
            html += `</div>`;
            if (booking) {
                html += `<p class="text-sm font-semibold">${booking.name}</p><p class="text-xs text-gray-500 dark:text-gray-400">${booking.contact}</p>
                     ${booking.grandTotal ? `<p class="text-sm mt-2"><span class="font-medium" data-lang-key="grand_total">${translations[currentLang].grand_total}</span> <span class="font-bold">₹${booking.grandTotal}</span></p>` : ''}`;
            } else {
                html += `<div class="text-center py-2"><p class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2">${translations[currentLang].vacant}</p>
                         <button class="add-slot-btn text-sm bg-primary text-text px-3 py-1 rounded-lg hover:bg-opacity-80 flex items-center gap-2 mx-auto" data-slot="${slotInfo.id}">
                         <i class="fa-solid fa-plus"></i> <span data-lang-key="add_booking">${translations[currentLang].add_booking}</span></button></div>`;
            }
            slotCard.innerHTML = html;
            bookingInfoEl.appendChild(slotCard);
        });
        renderCalendar();
    };

    const initDatepickers = (selector = '.date-picker') => {
        const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'default';
        flatpickr(selector, {
            dateFormat: "Y-m-d",
            theme: theme
        });
    };
    
    const renderInstallments = (installments = [], isViewing = false) => {
        const { installmentsContainer } = allDOMElements;
        installmentsContainer.innerHTML = '';
        const installmentHTML = (inst) => `
            <div class="flex items-center gap-2 installment-row">
                <input type="number" data-lang-placeholder="installment_amount" value="${inst.amount || ''}" class="installment-amount w-1/2 px-2 py-1 border rounded-md bg-background dark:bg-dark-background dark:border-dark-border" ${isViewing ? 'disabled' : ''}>
                <input type="text" data-lang-placeholder="installment_date" value="${inst.date || ''}" class="installment-date date-picker w-1/2 px-2 py-1 border rounded-md bg-background dark:bg-dark-background dark:border-dark-border" ${isViewing ? 'disabled' : ''}>
                ${!isViewing ? '<button type="button" class="remove-installment-btn w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full bg-red-100 hover:bg-red-200 text-red-600"><i class="fa-solid fa-minus"></i></button>' : ''}
            </div>
        `;
        if (installments.length > 0) {
            installments.forEach(inst => installmentsContainer.innerHTML += installmentHTML(inst));
        }
        updatePaymentSummary();
    };
    
    const setModalMode = (mode, bookingData = null) => {
        const { modalTitle, modalEditBtn, modalSaveBtn, cancelModalBtn, bookingForm, itemChecklist, addInstallmentBtn } = allDOMElements;
        const inputs = bookingForm.querySelectorAll('input, textarea');
        const isViewing = mode === 'view';

        inputs.forEach(input => { if (input.type !== 'hidden') input.disabled = isViewing; });

        itemChecklist.innerHTML = '';
        masterItems.forEach(item => {
            const bookedItem = bookingData?.items?.find(bi => bi.id === item.id);
            const quantity = bookedItem?.quantity || 0;
            const price = bookedItem?.price || item.price;
            const itemHTML = `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-2 items-center item-row p-2 rounded-md ${quantity > 0 ? 'bg-primary/10 dark:bg-primary/20' : ''}" data-item-id="${item.id}">
                    <div class="md:col-span-5 flex items-center gap-2">
                        <label class="text-sm truncate" title="${item[currentLang]}">${item[currentLang]}</label>
                    </div>
                    <div class="grid grid-cols-3 md:col-span-7 gap-2">
                        <div class="col-span-1">
                             <label class="block text-xs text-gray-500 md:hidden text-center mb-1" data-lang-key="item_price">Price</label>
                            <input type="number" value="${price}" class="item-price w-full text-center text-sm px-1 py-1 border rounded-md bg-background dark:bg-dark-background dark:border-dark-border">
                        </div>
                        <div class="col-span-1">
                             <label class="block text-xs text-gray-500 md:hidden text-center mb-1" data-lang-key="item_qty">Qty</label>
                            <input type="number" value="${quantity}" min="0" class="item-quantity w-full text-center text-sm px-1 py-1 border rounded-md bg-background dark:bg-dark-background dark:border-dark-border">
                        </div>
                        <div class="col-span-1 flex justify-end items-center">
                             <label class="block text-xs text-gray-500 md:hidden text-center mb-1" data-lang-key="item_total">Total</label>
                            <span class="item-total font-semibold text-right w-full">₹${price * quantity}</span>
                        </div>
                    </div>
                </div>`;
            itemChecklist.innerHTML += itemHTML;
        });
        
        document.getElementById('advanced-payment-amount').value = bookingData?.advancedPayment?.amount || '';
        document.getElementById('advanced-payment-date').value = bookingData?.advancedPayment?.date || '';

        renderInstallments(bookingData?.installments, isViewing);
        
        if (isViewing) {
             itemChecklist.querySelectorAll('input').forEach(i => i.disabled = true);
             addInstallmentBtn.classList.add('hidden');
             bookingForm.querySelectorAll('.installment-divider-btn').forEach(b => b.classList.add('hidden'));
        } else {
             addInstallmentBtn.classList.remove('hidden');
             bookingForm.querySelectorAll('.installment-divider-btn').forEach(b => b.classList.remove('hidden'));
        }

        modalEditBtn.classList.toggle('hidden', !isViewing);
        modalSaveBtn.classList.toggle('hidden', isViewing);
        cancelModalBtn.querySelector('span').textContent = isViewing ? translations[currentLang].close : translations[currentLang].cancel;
        if (mode === 'view') modalTitle.textContent = translations[currentLang].view_booking;
        else if (mode === 'edit') modalTitle.textContent = translations[currentLang].edit_booking;
        else modalTitle.textContent = translations[currentLang].add_new_booking;
        calculateTotals();
    };

    const openModal = (bookingData = null, slot = null, mode = 'add') => {
        if (!selectedDate && mode !== 'add') return;
        allDOMElements.bookingForm.reset();
        allDOMElements.installmentsContainer.innerHTML = '';
        const { modal, modalContent, modalDateDisplay } = allDOMElements;
        const isEditingOrViewing = mode === 'edit' || mode === 'view';
        const dateObj = new Date(selectedDate + 'T00:00:00');
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        modalDateDisplay.textContent = dateObj.toLocaleDateString(currentLang === 'gu' ? 'gu-IN' : 'en-US', options);
        document.getElementById('booking-date').value = selectedDate;
        document.getElementById('editing-slot').value = isEditingOrViewing ? bookingData.slot : '';
        if (isEditingOrViewing) {
            document.getElementById('customer-name').value = bookingData.name;
            document.getElementById('contact-info').value = bookingData.contact;
            document.getElementById('booking-details-text').value = bookingData.details || '';
        }
        const slotContainer = document.getElementById('booking-slot-container');
        slotContainer.classList.toggle('hidden', isEditingOrViewing);
        if (mode === 'add') {
            const bookingSlotsContainer = document.getElementById('booking-slots');
            bookingSlotsContainer.innerHTML = '';
            const dayBookings = bookings[selectedDate] || [];
            bookingSlots.forEach(slotInfo => {
                const isBooked = dayBookings.some(b => b.slot === slotInfo.id);
                bookingSlotsContainer.innerHTML += `<div><input type="radio" id="slot-${slotInfo.id}" name="booking-slot" value="${slotInfo.id}" class="hidden peer" ${isBooked ? 'disabled' : ''} ${slot === slotInfo.id ? 'checked' : ''}><label for="slot-${slotInfo.id}" class="block text-center px-4 py-2 border rounded-lg cursor-pointer ${isBooked ? 'bg-gray-200 dark:bg-dark-border text-gray-400 cursor-not-allowed' : 'peer-checked:bg-primary peer-checked:text-text peer-checked:border-primary hover:bg-gray-100 dark:hover:bg-dark-background'}">${translations[currentLang][slotInfo.id]}</label></div>`;
            });
        }
        setModalMode(mode, bookingData);
        initDatepickers(); // Initialize all date pickers in the modal
        updateLanguage(); // Update placeholders after initialization
        modal.classList.remove('hidden');
        setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
    };

    const closeModal = () => {
        allDOMElements.modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => allDOMElements.modal.classList.add('hidden'), 200);
    };
    const openDeleteModal = (date, slot) => {
        bookingToDelete = { date, slot };
        allDOMElements.deleteModal.classList.remove('hidden');
        setTimeout(() => allDOMElements.deleteModalContent.classList.remove('scale-95', 'opacity-0'), 10);
    };
    const closeDeleteModal = () => {
        allDOMElements.deleteModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => { allDOMElements.deleteModal.classList.add('hidden'); bookingToDelete = null; }, 200);
    };
    const confirmDelete = () => {
        if (!bookingToDelete) return;
        const { date, slot } = bookingToDelete;
        if (bookings[date]) {
            bookings[date] = bookings[date].filter(b => b.slot !== slot);
            if (bookings[date].length === 0) delete bookings[date];
        }
        saveState();
        closeDeleteModal();
        displayBookingDetails(date);
        renderUpcomingBookingsBanner();
    };
    
    const handleBookingSubmit = (e) => {
        e.preventDefault();
        const date = document.getElementById('booking-date').value;
        const name = document.getElementById('customer-name').value;
        const details = document.getElementById('booking-details-text').value;
        const contact = document.getElementById('contact-info').value;
        const editingSlot = document.getElementById('editing-slot').value;
        const selectedSlotEl = document.querySelector('input[name="booking-slot"]:checked');
        const slot = editingSlot || selectedSlotEl?.value;
        if (!slot) return;
        
        const bookedItems = [];
        const itemRows = allDOMElements.itemChecklist.querySelectorAll('.item-row');
        itemRows.forEach(row => {
            const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
            if (quantity > 0) {
                bookedItems.push({
                    id: row.dataset.itemId,
                    price: parseFloat(row.querySelector('.item-price').value) || 0,
                    quantity: quantity
                });
            }
        });
        const grandTotal = parseFloat(allDOMElements.grandTotalEl.textContent.replace('₹', ''));
        
        const advancedPaymentAmount = parseFloat(document.getElementById('advanced-payment-amount').value) || 0;
        const advancedPaymentDate = document.getElementById('advanced-payment-date').value;
        const advancedPayment = { amount: advancedPaymentAmount, date: advancedPaymentDate };

        const installments = [];
        document.querySelectorAll('.installment-row').forEach(row => {
            const amount = parseFloat(row.querySelector('.installment-amount').value);
            const date = row.querySelector('.installment-date').value;
            if (amount > 0 && date) {
                installments.push({ amount, date });
            }
        });
        
        const newBookingData = { slot, name, contact, details, items: bookedItems, grandTotal, advancedPayment, installments };
        if (editingSlot) {
            const bookingIndex = bookings[date].findIndex(b => b.slot === editingSlot);
            bookings[date][bookingIndex] = newBookingData;
        } else {
            if (!bookings[date]) bookings[date] = [];
            bookings[date].push(newBookingData);
        }
        saveState();
        displayBookingDetails(date);
        renderUpcomingBookingsBanner();
        closeModal();
    };
    
    const toggleTheme = () => {
        const isDark = document.documentElement.classList.toggle('dark');
        allDOMElements.themeIcon.className = isDark ? 'fa-solid fa-moon text-lg text-accent' : 'fa-solid fa-sun text-lg text-yellow-500';
        saveState();
    };

    // --- ANIMATIONS ---
    const setupAnimations = () => {
        const { animate } = Motion;

        // Header icon animation
        const headerTitle = document.querySelector('h1');
        if (headerTitle) {
            headerTitle.addEventListener('mouseenter', () => {
                animate('#header-icon', { rotate: [-10, 10, -5, 5, 0] }, { duration: 0.7, easing: "ease-in-out" });
            });
        }

        // Theme switcher animation
        const themeSwitcher = document.getElementById('theme-switcher');
        if (themeSwitcher) {
            themeSwitcher.addEventListener('mouseenter', () => {
                animate('#theme-icon', { rotate: [0, 90, 0] }, { duration: 0.5 });
            });
        }

        // Calendar navigation animation
        const prevMonthBtn = document.getElementById('prev-month');
        if (prevMonthBtn) {
            prevMonthBtn.addEventListener('mouseenter', () => {
                animate('#prev-month-icon', { x: [-3, 3, 0] }, { duration: 0.4 });
            });
        }
        const nextMonthBtn = document.getElementById('next-month');
        if (nextMonthBtn) {
            nextMonthBtn.addEventListener('mouseenter', () => {
                animate('#next-month-icon', { x: [3, -3, 0] }, { duration: 0.4 });
            });
        }
        
        // Modal buttons animation
        const animatedButtons = document.querySelectorAll('#cancel-modal-btn, #modal-edit-btn, #modal-save-btn, #confirm-delete-btn');
        animatedButtons.forEach(button => {
            button.addEventListener('mouseenter', () => {
                const icon = button.querySelector('i');
                if (icon) {
                    animate(icon, { scale: [1, 1.25, 1] }, { duration: 0.3 });
                }
            });
        });

        // Add booking button in details view animation (using event delegation)
        const bookingInfoEl = document.getElementById('booking-info');
        if (bookingInfoEl) {
            bookingInfoEl.addEventListener('mouseenter', (e) => {
                const button = e.target.closest('.add-slot-btn');
                if (button) {
                    const icon = button.querySelector('i');
                    if (icon) {
                        animate(icon, { rotate: [0, 90, 0] }, { duration: 0.4 });
                    }
                }
            }, true);
        }
    };


    // --- EVENT LISTENERS ---
    const setupEventListeners = () => {
        const { prevMonthBtn, nextMonthBtn, calendarGridEl, modal, bookingForm, cancelModalBtn, languageToggleBtn, themeSwitcher, gotoTodayBtn, confirmDeleteBtn, cancelDeleteBtn, deleteModal, modalEditBtn, itemChecklist, addInstallmentBtn, installmentsContainer, modalCloseBtnTop } = allDOMElements;
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        gotoTodayBtn.addEventListener('click', () => {
            currentDate = new Date();
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            displayBookingDetails(todayStr);
        });
        calendarGridEl.addEventListener('click', e => e.target.closest('[data-date]')?.dataset.date && displayBookingDetails(e.target.closest('[data-date]').dataset.date));
        modal.addEventListener('click', e => e.target === modal && closeModal());
        bookingForm.addEventListener('submit', handleBookingSubmit);
        cancelModalBtn.addEventListener('click', closeModal);
        modalCloseBtnTop.addEventListener('click', closeModal);
        languageToggleBtn.addEventListener('click', () => {
            currentLang = currentLang === 'en' ? 'gu' : 'en';
            updateLangButtonText();
            saveState();
            updateLanguage();
        });
        themeSwitcher.addEventListener('click', toggleTheme);
        confirmDeleteBtn.addEventListener('click', confirmDelete);
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        deleteModal.addEventListener('click', (e) => e.target === deleteModal && closeDeleteModal());
        modalEditBtn.addEventListener('click', () => {
            const bookingToEdit = bookings[selectedDate]?.find(b => b.slot === document.getElementById('editing-slot').value);
            setModalMode('edit', bookingToEdit)
        });
        bookingInfoEl.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button || !selectedDate) return;
            const slot = button.dataset.slot;
            if (button.classList.contains('view-btn')) {
                const bookingToView = bookings[selectedDate]?.find(b => b.slot === slot);
                if (bookingToView) openModal(bookingToView, null, 'view');
            }
            if (button.classList.contains('delete-btn')) openDeleteModal(selectedDate, slot);
            if (button.classList.contains('add-slot-btn')) openModal(null, slot, 'add');
        });
        
        itemChecklist.addEventListener('input', e => {
            if (e.target.classList.contains('item-price') || e.target.classList.contains('item-quantity')) {
                const row = e.target.closest('.item-row');
                const quantityInput = row.querySelector('.item-quantity');
                const quantity = parseInt(quantityInput.value) || 0;
                if(quantity > 0) row.classList.add('bg-primary/10', 'dark:bg-primary/20');
                else {
                    row.classList.remove('bg-primary/10', 'dark:bg-primary/20');
                    quantityInput.value = 0;
                }
                calculateTotals();
            }
        });

        document.getElementById('advanced-payment-amount').addEventListener('input', updatePaymentSummary);
        installmentsContainer.addEventListener('input', e => {
            if (e.target.classList.contains('installment-amount')) {
                updatePaymentSummary();
            }
        });

        addInstallmentBtn.addEventListener('click', () => {
            const newRowHTML = `
                <div class="flex items-center gap-2 installment-row">
                    <input type="number" data-lang-placeholder="installment_amount" class="installment-amount w-1/2 px-2 py-1 border rounded-md bg-background dark:bg-dark-background dark:border-dark-border">
                    <input type="text" data-lang-placeholder="installment_date" class="installment-date date-picker w-1/2 px-2 py-1 border rounded-md bg-background dark:bg-dark-background dark:border-dark-border">
                    <button type="button" class="remove-installment-btn w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full bg-red-100 hover:bg-red-200 text-red-600"><i class="fa-solid fa-minus"></i></button>
                </div>`;
            installmentsContainer.insertAdjacentHTML('beforeend', newRowHTML);
            const newRowEl = installmentsContainer.lastElementChild;
            initDatepickers(newRowEl.querySelector('.date-picker'));
            updateLanguage();
        });

        installmentsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-installment-btn')) {
                e.target.closest('.installment-row').remove();
                updatePaymentSummary();
            }
        });
        
        bookingForm.addEventListener('click', e => {
            const dividerBtn = e.target.closest('.installment-divider-btn');
            if(!dividerBtn) return;
            
            const count = parseInt(dividerBtn.dataset.count);
            const { remainingAmount } = updatePaymentSummary();
            
            if (remainingAmount <= 0) return;
            
            installmentsContainer.innerHTML = '';
            
            const baseAmount = Math.floor(remainingAmount / count);
            const remainder = remainingAmount - baseAmount * count;
            
            for (let i = 0; i < count; i++) {
                const amountForThisInstallment = baseAmount + (i < remainder ? 1 : 0);
                if (amountForThisInstallment <= 0) continue;
                const newRowHTML = `
                    <div class="flex items-center gap-2 installment-row">
                        <input type="number" value="${amountForThisInstallment.toFixed(2)}" data-lang-placeholder="installment_amount" class="installment-amount w-1/2 px-2 py-1 border rounded-md bg-background dark:bg-dark-background dark:border-dark-border">
                        <input type="text" data-lang-placeholder="installment_date" class="installment-date date-picker w-1/2 px-2 py-1 border rounded-md bg-background dark:bg-dark-background dark:border-dark-border">
                        <button type="button" class="remove-installment-btn w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full bg-red-100 hover:bg-red-200 text-red-600"><i class="fa-solid fa-minus"></i></button>
                    </div>`;
                installmentsContainer.insertAdjacentHTML('beforeend', newRowHTML);
            }
            
            initDatepickers('.installment-date');
            updateLanguage();
            updatePaymentSummary();
        });
    };

    // --- INITIALIZATION ---
    loadState();
    updateLanguage();
    updateLangButtonText();
    allDOMElements.themeIcon.className = document.documentElement.classList.contains('dark') ? 'fa-solid fa-moon text-lg text-accent' : 'fa-solid fa-sun text-lg text-yellow-500';
    setupEventListeners();
    setupAnimations();
});
</script>

</body>
</html>

